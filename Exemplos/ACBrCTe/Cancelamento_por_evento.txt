procedure TfrmMovCancelarCNT.CancelarConhecimentoEvento;
begin
 DMCTe.CTe.EventoCTe.Evento.Clear;

 with DMCTe.CTe.EventoCTe.Evento.Add do
  begin
   infevento.chCTe           := Chave;
   infEvento.CNPJ            := Copy(DM_CTA.EmpresaCNPJ.AsString, 2, 14);
   infEvento.dhEvento        := now;
   infEvento.tpEvento        := teCancelamento;
   infEvento.detEvento.xJust := trim(edtJustificativa.Text);
   infEvento.detEvento.nProt := Protocolo;
  end;

 // Lote de Eventos
 DM_VEN.LoteEve.Close;
 DM_VEN.LoteEve.SQL.Clear;
 DM_VEN.LoteEve.SQL.Add('Select * From Eve_Lote');
 DM_VEN.LoteEve.SQL.Add('Where Empresa = :xEmpresa');
 DM_VEN.LoteEve.SQL.Add('Order By Lote');
 DM_VEN.LoteEve.Params[0].AsString:=DM_CTA.xCodEmpresa;
 DM_VEN.LoteEve.Active:=True;
 DM_VEN.LoteEve.Open;
 DM_VEN.LoteEve.Last;
 if DM_VEN.LoteEve.RecordCount>0
  then begin
   if (DM_VEN.LoteEveEveInicial.AsInteger=0) and
      (DM_VEN.LoteEveEveFinal.AsInteger=0)
    then idLote:=DM_VEN.LoteEveLote.AsInteger
    else begin
     idLote:=(DM_VEN.LoteEveLote.AsInteger+1);

     DM_VEN.IncAltDel.SQL.Clear;
     DM_VEN.IncAltDel.SQL.Add('Insert into Eve_Lote');
     DM_VEN.IncAltDel.SQL.Add('(Empresa, Lote, EveInicial, EveFinal, Data)');
     DM_VEN.IncAltDel.SQL.Add('Values (:xEmpresa, :xLote, :xEveInicial, :xEveFinal, :xData)');
     DM_VEN.IncAltDel.Params[0].AsString:=DM_CTA.xCodEmpresa;
     DM_VEN.IncAltDel.Params[1].AsInteger:=idLote;
     DM_VEN.IncAltDel.Params[2].AsInteger:=0;
     DM_VEN.IncAltDel.Params[3].AsInteger:=0;
     DM_VEN.IncAltDel.Params[4].AsDateTime:=Date;
     DM_VEN.IncAltDel.ExecSQL;
   end;
  end
  else begin
   idLote:=1;

   DM_VEN.IncAltDel.SQL.Clear;
   DM_VEN.IncAltDel.SQL.Add('Insert into Eve_Lote');
   DM_VEN.IncAltDel.SQL.Add('(Empresa, Lote, EveInicial, EveFinal, Data)');
   DM_VEN.IncAltDel.SQL.Add('Values (:xEmpresa, :xLote, :xEveInicial, :xEveFinal, :xData)');
   DM_VEN.IncAltDel.Params[0].AsString:=DM_CTA.xCodEmpresa;
   DM_VEN.IncAltDel.Params[1].AsInteger:=idLote;
   DM_VEN.IncAltDel.Params[2].AsInteger:=0;
   DM_VEN.IncAltDel.Params[3].AsInteger:=0;
   DM_VEN.IncAltDel.Params[4].AsDateTime:=Date;
   DM_VEN.IncAltDel.ExecSQL;
  end;

 DMCTe.CTe.EnviarEventoCTe(idLote);

 EveInicial := DMCTe.CTe.Conhecimentos.Items[0].CTe.Ide.nCT;
 EveFinal   := EveInicial;

 DM_VEN.IncAltDel.SQL.Clear;
 DM_VEN.IncAltDel.SQL.Add('Update Eve_Lote Set');
 DM_VEN.IncAltDel.SQL.Add('EveInicial = :xEveInicial,');
 DM_VEN.IncAltDel.SQL.Add('EveFinal = :xEveFinal,');
 DM_VEN.IncAltDel.SQL.Add('Data = :xData');
 DM_VEN.IncAltDel.SQL.Add('Where Empresa = :xEmpresa');
 DM_VEN.IncAltDel.SQL.Add('and Lote = :xLote');
 DM_VEN.IncAltDel.Params[0].AsInteger:=EveInicial;
 DM_VEN.IncAltDel.Params[1].AsInteger:=EveFinal;
 DM_VEN.IncAltDel.Params[2].AsDateTime:=Date;
 DM_VEN.IncAltDel.Params[3].AsString:=DM_CTA.xCodEmpresa;
 DM_VEN.IncAltDel.Params[4].AsInteger:=idLote;
 DM_VEN.IncAltDel.ExecSQL;

 MemoStatus.Lines.Add('-------------------------------------------------------------------------------------------');
 MemoStatus.Lines.Add(' =>  Cancelando CT-e com chave de acesso nº ' + DM_CNT.Conhec2ChaveCTe.AsString );
 MemoStatus.Lines.Add('-------------------------------------------------------------------------------------------');
 MemoStatus.Lines.Add('  Justificativa: ' + edtJustificativa.Text);

 sProtocolo := DMCTe.CTe.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.nProt;
 sStat      := IntToStr(DMCTe.CTe.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.cStat);
 sMotivo    := DMCTe.CTe.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.xMotivo;
 sDataHora  := DateTimeToStr(DMCTe.CTe.WebServices.EnvEvento.EventoRetorno.retEvento.Items[0].RetInfEvento.dhRegEvento);

 MemoStatus.Lines.Add('  Protocolo    : ' + sProtocolo);
 MemoStatus.Lines.Add('  Status       : ' + sStat);
 MemoStatus.Lines.Add('  Motivo       : ' + sMotivo);
 MemoStatus.Lines.Add('  Data/Hora    : ' + sDataHora);
 MemoStatus.Lines.Add(' ');
end;
